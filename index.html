<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Pop RPG</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff6f91">

<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">

<style>
html,body{
  min-height:100%;
}
body{
  margin:0;
  font-family:'Kosugi Maru', monospace;
  background:linear-gradient(135deg,#ff9a9e,#fad0c4);
  background-attachment:fixed;
}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
header{
  background:#fff;
  text-align:center;
  padding:12px;
  border-bottom:4px solid #ff6f91;
}
.sprite{
  width:80px;
  height:80px;
  image-rendering:pixelated;
}
.stats{
  font-size:16px;
  line-height:1.4;
}

/* ===== ãƒŠãƒ“ ===== */
nav{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  display:flex;
  background:#fff;
  border-top:4px solid #ff6f91;
  padding-bottom:env(safe-area-inset-bottom);
}
nav button{
  flex:1;
  padding:12px;
  border:none;
  background:#fff;
  color:#ff6f91;
}
nav button.active{
  background:#ff6f91;
  color:#fff;
}

/* ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
section{
  display:none;
  padding:16px;
  padding-bottom:120px;
}
section.active{
  display:block;
}

/* ===== ã‚«ãƒ¼ãƒ‰ ===== */
.card{
  background:#fff;
  padding:14px;
  border-radius:16px;
  margin-bottom:12px;
  box-shadow:0 6px 0 #ff6f91;
}
input,select{
  width:100%;
  padding:8px;
  border-radius:12px;
  border:2px solid #ff6f91;
  margin-bottom:6px;
}
button{
  background:#ff6f91;
  color:#fff;
  border:none;
  border-radius:12px;
  padding:8px 12px;
  box-shadow:0 4px 0 #d94f70;
}
button:active{
  transform:translateY(4px);
  box-shadow:none;
}

/* ===== ã‚°ãƒ©ãƒ• ===== */
canvas{
  width:100%;
  max-width:340px;
  height:260px;
  display:block;
  margin:0 auto;
}

/* ===== æ¼”å‡º ===== */
#effectText{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-weight:bold;
  font-size:36px;
  display:none;
  z-index:999;
}
</style>
</head>

<body>

<header>
  <div id="playerName"></div>
  <img id="sprite" class="sprite">
  <div class="stats">
    Lv.<span id="level"></span>/50<br>
    EXP <span id="exp"></span><br>
    ğŸ’° <span id="gold"></span>
  </div>
</header>

<!-- ===== ã‚¿ã‚¹ã‚¯ ===== -->
<section id="tasks" class="active">
  <div class="card">
    <input id="taskTitle" placeholder="ã‚¿ã‚¹ã‚¯å">
    <select id="taskUrgency">
      <option value="1">ç·Šæ€¥åº¦ï¼šä½</option>
      <option value="2">ç·Šæ€¥åº¦ï¼šä¸­</option>
      <option value="3">ç·Šæ€¥åº¦ï¼šé«˜</option>
    </select>
    <input id="taskDeadline" type="date">
    <button onclick="addTask()">ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
  </div>
  <div id="taskList"></div>
</section>

<!-- ===== å‹‰å¼· ===== -->
<section id="study">
  <div class="card">
    <input id="studyMinutes" type="number" placeholder="å‹‰å¼·æ™‚é–“ï¼ˆåˆ†ï¼‰">
    <button onclick="addStudy()">è¨˜éŒ²</button>
  </div>

  <div class="card">
    åˆè¨ˆå­¦ç¿’æ™‚é–“ï¼š<span id="totalStudy">0</span> åˆ†<br>
    é€£ç¶šå­¦ç¿’æ—¥æ•°ï¼š<span id="streak">0</span> æ—¥
  </div>

  <div class="card" style="text-align:center">
    <button onclick="changeWeek(-1)">â—€</button>
    <button id="nextWeekBtn" onclick="changeWeek(1)">â–¶</button><br><br>
    <canvas id="studyChart"></canvas>
  </div>
</section>

<!-- ===== äº¤æ›æ‰€ ===== -->
<section id="shop">
  <div class="card">
    <input id="itemName" placeholder="ãƒªãƒ¯ãƒ¼ãƒ‰å">
    <input id="itemCost" type="number" placeholder="å¿…è¦G">
    <button onclick="addShopItem()">è¿½åŠ </button>
  </div>
  <div id="shopList"></div>
</section>

<nav>
  <button class="active" onclick="showTab('tasks',this)">ã‚¿ã‚¹ã‚¯</button>
  <button onclick="showTab('study',this)">å‹‰å¼·</button>
  <button onclick="showTab('shop',this)">äº¤æ›æ‰€</button>
</nav>

<div id="effectText"></div>

<script>
let busy=false;
let weekOffset=0;

let data=JSON.parse(localStorage.getItem("studyPopRPG"))||{
  name:"",
  level:1,
  exp:0,
  gold:0,
  tasks:[],
  shopItems:[],
  studyLogs:{}
};

if(!data.name) data.name=prompt("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›");
const save=()=>localStorage.setItem("studyPopRPG",JSON.stringify(data));
const expToNext=()=>data.level*100;

function spriteByLevel(){
  if(data.level<15) return "image/New Piskel-1.png";
  if(data.level<30) return "image/New Piskel-2.png";
  return "image/New Piskel-3.png";
}

/* ===== æ¼”å‡º ===== */
function showEffect(text,color){
  effectText.textContent=text;
  effectText.style.color=color;
  effectText.style.display="block";
  setTimeout(()=>effectText.style.display="none",600);
}
function showLevelUp(){
  effectText.textContent="LEVEL UP!!";
  effectText.style.color="#FFD700";
  effectText.style.fontSize="42px";
  effectText.style.display="block";
  setTimeout(()=>{
    effectText.style.display="none";
    effectText.style.fontSize="36px";
  },800);
}

/* ===== ãƒ¬ãƒ™ãƒ«åˆ¤å®šï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰ ===== */
function levelCheck(){
  let up=false;
  while(data.exp>=expToNext() && data.level<50){
    data.exp-=expToNext();
    data.level++;
    up=true;
  }
  if(up) showLevelUp();
}

/* ===== ã‚¿ã‚¹ã‚¯ ===== */
function addTask(){
  if(!taskTitle.value) return;
  data.tasks.push({
    title:taskTitle.value,
    urgency:+taskUrgency.value,
    deadline:taskDeadline.value||null
  });
  taskTitle.value=taskDeadline.value="";
  save(); render();
}
function completeTask(i){
  if(busy) return;
  busy=true;
  const t=data.tasks[i];
  data.tasks.splice(i,1);
  data.exp+=t.urgency*30;
  data.gold+=t.urgency*10;
  levelCheck();
  showEffect("å®Œäº†","#00aaee");
  save(); render();
  setTimeout(()=>busy=false,600);
}
function deleteTask(i){
  data.tasks.splice(i,1);
  save(); render();
}

/* ===== å‹‰å¼· ===== */
function addStudy(){
  const min=+studyMinutes.value;
  if(min<=0) return;
  const d=new Date().toISOString().split("T")[0];
  data.studyLogs[d]=(data.studyLogs[d]||0)+min;
  data.exp+=min;
  data.gold+=Math.floor(min/2);
  levelCheck();
  studyMinutes.value="";
  showEffect("è¨˜éŒ²","#00cc66");
  save(); render();
}

/* ===== äº¤æ›æ‰€ ===== */
function addShopItem(){
  if(!itemName.value||!itemCost.value) return;
  data.shopItems.push({name:itemName.value,cost:+itemCost.value});
  itemName.value=itemCost.value="";
  save(); render();
}
function buyItem(i){
  const s=data.shopItems[i];
  if(data.gold<s.cost) return;
  data.gold-=s.cost;
  showEffect("è³¼å…¥","#ff9933");
  save(); render();
}
function deleteShopItem(i){
  data.shopItems.splice(i,1);
  save(); render();
}

/* ===== ã‚°ãƒ©ãƒ• ===== */
function getWeekDates(){
  const t=new Date();
  const s=new Date(t);
  s.setDate(t.getDate()-t.getDay()+weekOffset*7);
  return [...Array(7)].map((_,i)=>{
    const d=new Date(s);
    d.setDate(s.getDate()+i);
    return d;
  });
}

function drawChart(){
  const canvas=studyChart;
  const ctx=canvas.getContext("2d");
  const dpr=window.devicePixelRatio||1;
  const cssW=canvas.clientWidth;
  const cssH=260;

  canvas.width=cssW*dpr;
  canvas.height=cssH*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,cssW,cssH);

  ctx.font="13px 'Kosugi Maru'";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  ctx.fillStyle="#000";

  const dates=getWeekDates();
  const names=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  const today=new Date().toISOString().split("T")[0];

  const values=dates.map(d=>{
    const k=d.toISOString().split("T")[0];
    return data.studyLogs[k]||0;
  });

  const max=Math.max(60,...values);
  const barArea=cssH-90;
  const w=cssW/7;

  dates.forEach((d,i)=>{
    const key=d.toISOString().split("T")[0];
    const cx=i*w+w/2;

    ctx.fillText(names[i],cx,cssH-34);
    ctx.fillText(`${d.getMonth()+1}/${d.getDate()}`,cx,cssH-18);

    if(key>today) return;
    const v=values[i];
    if(v<=0) return;

    const h=(v/max)*barArea;
    ctx.fillStyle="#ff6f91";
    ctx.fillRect(i*w+16,cssH-h-50,w-32,h);
    ctx.fillStyle="#000";
    ctx.fillText(v+"åˆ†",cx,cssH-h-62);
  });

  nextWeekBtn.disabled=weekOffset>=0;
}

function changeWeek(n){
  if(weekOffset+n>0) return;
  weekOffset+=n;
  drawChart();
}

/* ===== ã‚¿ãƒ– ===== */
function showTab(id,btn){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  btn.classList.add("active");
  if(id==="study") drawChart();
}

/* ===== æç”» ===== */
function render(){
  playerName.textContent=data.name;
  level.textContent=data.level;
  exp.textContent=data.exp+"/"+expToNext();
  gold.textContent=data.gold;
  sprite.src=spriteByLevel();

  taskList.innerHTML="";
  data.tasks.forEach((t,i)=>{
    const today=new Date().toISOString().split("T")[0];
    const expired=t.deadline && t.deadline<today;
    taskList.innerHTML+=`
      <div class="card" style="${expired?'opacity:.6':''}">
        ${t.title}<br>
        ç·Šæ€¥åº¦ï¼š${["ä½","ä¸­","é«˜"][t.urgency-1]}<br>
        æœŸé™ï¼š${t.deadline||"ãªã—"} ${expired?"âš ï¸æœŸé™åˆ‡ã‚Œ":""}<br>
        <button onclick="completeTask(${i})">å®Œäº†</button>
        <button onclick="deleteTask(${i})">å‰Šé™¤</button>
      </div>`;
  });

  shopList.innerHTML="";
  data.shopItems.forEach((s,i)=>{
    shopList.innerHTML+=`
      <div class="card">
        ${s.name}<br>
        å¿…è¦Gï¼š${s.cost}<br>
        <button onclick="buyItem(${i})">äº¤æ›</button>
        <button onclick="deleteShopItem(${i})">å‰Šé™¤</button>
      </div>`;
  });

  const total=Object.values(data.studyLogs).reduce((a,b)=>a+b,0);
  totalStudy.textContent=total;

  let streak=0;
  let d=new Date();
  while(true){
    const k=d.toISOString().split("T")[0];
    if(data.studyLogs[k]){streak++;d.setDate(d.getDate()-1);}
    else break;
  }
  document.getElementById("streak").textContent=streak;

  drawChart();
}

render();
</script>
</body>
</html>
